#!/bin/bash

# Konfigurasi
MAX_VOLUME=100
STEP=5
NOTIFY=true
ICONS=false  # Set true jika mau pakai icon

# Fungsi untuk mendapatkan volume
get_volume() {
    # Coba pactl dulu (PulseAudio compatibility)
    if pactl info 2>/dev/null | grep -q "PipeWire"; then
        # Pakai pactl untuk PipeWire
        volume=$(pactl get-sink-volume @DEFAULT_SINK@ | \
            awk '{print $5}' | sed 's/%//' | head -1)
        mute=$(pactl get-sink-mute @DEFAULT_SINK@ | awk '{print $2}')
        echo "$volume $mute"
    elif command -v wpctl >/dev/null 2>&1; then
        # Pakai wpctl (WirePlumber)
        wp_output=$(wpctl get-volume @DEFAULT_AUDIO_SINK@ 2>/dev/null)
        if [ $? -eq 0 ]; then
            # Format: "Volume: 0.50 [MUTED]" atau "Volume: 0.50"
            volume=$(echo "$wp_output" | grep -o "Volume: [0-9]\.[0-9]*" | cut -d' ' -f2)
            volume=$(echo "$volume * 100" | bc | cut -d'.' -f1)
            if echo "$wp_output" | grep -q "MUTED"; then
                mute="yes"
            else
                mute="no"
            fi
            echo "$volume $mute"
        else
            echo "0 yes"
        fi
    else
        echo "0 yes"
    fi
}

# Fungsi untuk menampilkan icon
get_icon() {
    local volume=$1
    local mute=$2
    
    if [ "$ICONS" = true ]; then
        if [ "$mute" = "yes" ] || [ "$volume" -eq 0 ]; then
            echo "󰝟"  # Muted
        elif [ "$volume" -lt 30 ]; then
            echo "󰕿"  # Low
        elif [ "$volume" -lt 70 ]; then
            echo "󰖀"  # Medium
        else
            echo "󰕾"  # High
        fi
    else
        if [ "$mute" = "yes" ] || [ "$volume" -eq 0 ]; then
            echo "MUT"
        else
            echo "$volume%"
        fi
    fi
}

# Fungsi untuk notifikasi
notify_volume() {
    local volume=$1
    local mute=$2
    
    if [ "$NOTIFY" = false ]; then
        return
    fi
    
    if [ "$mute" = "yes" ]; then
        message="Muted"
        icon="audio-volume-muted"
    else
        message="Volume: $volume%"
        if [ "$volume" -lt 30 ]; then
            icon="audio-volume-low"
        elif [ "$volume" -lt 70 ]; then
            icon="audio-volume-medium"
        else
            icon="audio-volume-high"
        fi
    fi
    
    # Gunakan dunst atau notify-send
    if command -v dunstify >/dev/null 2>&1; then
        dunstify -t 1000 -h "int:value:$volume" -i "$icon" "Volume" "$message"
    elif command -v notify-send >/dev/null 2>&1; then
        notify-send -t 1000 -i "$icon" "Volume" "$message"
    fi
}

# Main function
case "$1" in
    "--up"|"up")
        # Naikkan volume
        if pactl info 2>/dev/null | grep -q "PipeWire"; then
            current_volume=$(get_volume | awk '{print $1}')
            if [ $((current_volume + STEP)) -gt $MAX_VOLUME ]; then
                pactl set-sink-volume @DEFAULT_SINK@ $MAX_VOLUME%
            else
                pactl set-sink-volume @DEFAULT_SINK@ +${STEP}%
            fi
            pactl set-sink-mute @DEFAULT_SINK@ 0
        elif command -v wpctl >/dev/null 2>&1; then
            wpctl set-mute @DEFAULT_AUDIO_SINK@ 0
            wpctl set-volume @DEFAULT_AUDIO_SINK@ ${STEP}%+
        fi
        ;;
    
    "--down"|"down")
        # Turunkan volume
        if pactl info 2>/dev/null | grep -q "PipeWire"; then
            pactl set-sink-volume @DEFAULT_SINK@ -${STEP}%
        elif command -v wpctl >/dev/null 2>&1; then
            wpctl set-volume @DEFAULT_AUDIO_SINK@ ${STEP}%-
        fi
        ;;
    
    "--mute"|"mute")
        # Toggle mute
        if pactl info 2>/dev/null | grep -q "PipeWire"; then
            pactl set-sink-mute @DEFAULT_SINK@ toggle
        elif command -v wpctl >/dev/null 2>&1; then
            wpctl set-mute @DEFAULT_AUDIO_SINK@ toggle
        fi
        ;;
    
    "--toggle-mic"|"toggle-mic")
        # Toggle microphone mute
        if pactl info 2>/dev/null | grep -q "PipeWire"; then
            pactl set-source-mute @DEFAULT_SOURCE@ toggle
        elif command -v wpctl >/dev/null 2>&1; then
            wpctl set-mute @DEFAULT_AUDIO_SOURCE@ toggle
        fi
        ;;
    
    *)
        # Tampilkan volume saat ini (untuk polybar)
        read volume mute <<< $(get_volume)
        get_icon "$volume" "$mute"
        exit 0
        ;;
esac

# Tampilkan volume baru setelah perubahan
sleep 0.1
read volume mute <<< $(get_volume)
get_icon "$volume" "$mute"

# Tampilkan notifikasi
notify_volume "$volume" "$mute"
